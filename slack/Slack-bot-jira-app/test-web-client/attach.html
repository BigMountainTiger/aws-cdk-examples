<html>

<style>
  body {
    font-family: sans-serif;
  }

  fieldset>legend {
    font-size: 20px;
    font-weight: 600;
  }

  #div_status {
    font-weight: 600;
  }

  .status {
    margin-top: 8px;
  }

  #pre_status {
    margin-top: 2px;
  }

</style>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

<script>
  // Upload file to API Gateway.
  // https://stackoverflow.com/questions/38426638/s3-form-file-upload-via-aws-api-gateway

</script>

<script>
  const urlBase = 'https://o75t8p1795.execute-api.us-east-1.amazonaws.com/prod/service-desk/';
</script>

<script>
  let binary = null;
  let filename = null;
  
  const previewFile = function() {
    update_status();

    const file = document.querySelector('input[type=file]').files[0];
    const preview = document.querySelector('img');
    const reader = new FileReader();

    reader.addEventListener("load", function () {
      let base64 = reader.result;

      let i = base64.indexOf(',');
      binary = base64.substring(i + 1);
      const type = base64.substring(0, i);

      if (type.indexOf('image') >= 0) {
        preview.src = base64;
        preview.style.display = 'initial';
      }
      else {
        preview.src = '';
        preview.style.display = 'none';
      }

    }, false);

    if (file) {
      reader.readAsDataURL(file); 
      filename = file.name;
    }
  };

  const attach_file = function() {

    if (!binary || !filename) {
      update_status('N/A', 'You need to select a file');
      return;
    }

    const key = 'GSD-244';
    const url = urlBase + 'attach' + '/' + key + '/' + filename + '/';

    console.log(url);

    update_status('Uploading', 'The file ' + filename + ' is being uploaded ...');

    $.ajax({
      type: 'POST',
      url: url,
      data: binary,
      contentType: 'text/plain'
    }).always(function(jqx, status) {
      console.log(jqx);
      const result = jqx.responseJSON || jqx;
      
      update_status(status, JSON.stringify(result, null, 2));
    });

  };

  const clear_data = function() {
    const file = document.querySelector('input[type=file]');
    const preview = document.querySelector('img');

    binary = null;
    filename = null;
    preview.src = '';
    preview.style.display = 'none';
    file.value = '';
  };

  const update_status = function(status, detail) {

    if(status) {
      document.getElementById('div_status').textContent = 'Status: ' + status;;
      document.getElementById('pre_status').textContent = detail;
    }
    else {
      document.getElementById('div_status').textContent = null;
      document.getElementById('pre_status').textContent = null;
    }
  };

  const clear_all = function() {
    update_status();
    clear_data();
  };

</script>

<body>
  <fieldset>
    <legend>Attach a file</legend>
    <button onclick="clear_all()">Clear</button>
    <button onclick="attach_file()">Submit</button>
    <input type="file" onchange="previewFile()" />
    <div class="status">
      <div id="div_status"></div>
      <pre id="pre_status"></pre>
    </div>
    <img style="display: none;" src="" width="400px" alt="Image preview...">
  </fieldset>
</body>

</html>