<!DOCTYPE html>
<html>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
  </head>

  <script>
    window.onload = function() {

      if (!Promise) {
        const load_promise = function() {
          const js = document.createElement("script");
          js.type = 'text/javascript';
          js.src = 'https://cdnjs.cloudflare.com/ajax/libs/bluebird/3.7.2/bluebird.min.js';
          document.body.appendChild(js);
        };

        load_promise();
      }
    };

    const AJAX = function(rq) {
      const xhttp = new XMLHttpRequest();
      xhttp.open(rq.method || 'GET', rq.url, true);
      xhttp.send(rq.data);

      return new Promise(function(rs, rj) {

        xhttp.onreadystatechange = function() {
          if (xhttp.readyState != 4) { return; }

          const status = xhttp.status;
          if ((status == 200) || (rq.scode || []).includes(status)) { rs(xhttp); } else { rj(xhttp); }
        };
      });

    };
    
  </script>

  <script>
    // The url to get the presigned url
    const base_url = 'https://cwu3ebqzeb.execute-api.us-east-1.amazonaws.com/prod/';

    const post_by_presigned_url = function() {
      const file = document.getElementById("input-file");
      let s3_key = null;

      if (file.value == '') {
        alert('No file selected');
        return;
      }

      // Start to make chains of AJAX calls
      AJAX( { url: base_url + 'post_presigned_python' }).then(function(v) {

        const s3 = JSON.parse(v.response).presigned_url;

        const data = new FormData();
        const fields = s3.fields;
        for ( let key in fields ) {
          data.append(key, fields[key]);
        }
        data.append("file", file.files[0]);
        
        s3_key = fields.key;
        return AJAX({ url: s3.url, method: 'POST', data: data, scode: [204] });

      }).then(function(v) {
        return AJAX ({ url: base_url + 'get_presigned_python/' + s3_key });

      }).then(function(v) {
        
        const presigned_url = JSON.parse(v.response).presigned_url;
        console.log(presigned_url);

      }).catch(function(v) {

        alert('something wrong');
        console.log(v);

      });
    };

  </script>

<body>

  <button onclick="post_by_presigned_url()">Submit</button>
  <input autocomplete="off" id="input-file" type="file"><br>

</body>
</html>