<!DOCTYPE html>
<html>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
  </head>

  <script>
    window.onload = function() {

      if (!Promise) {
        let load_promise = function() {
          let js = document.createElement("script");
          js.type = 'text/javascript';
          js.src = 'https://cdnjs.cloudflare.com/ajax/libs/bluebird/3.7.2/bluebird.min.js';
          document.body.appendChild(js);
        };

        load_promise();
      }
    };

    let AJAX = function(rq) {
      let xhttp = new XMLHttpRequest();
      xhttp.open(rq.method || 'GET', rq.url, true);
      xhttp.send(rq.data);

      return new Promise(function(rs, rj) {

        xhttp.onreadystatechange = function() {
          if (xhttp.readyState != 4) { return; }

          let status = xhttp.status;
          if ((status == 200) || (rq.scode || []).includes(status)) { rs(xhttp); } else { rj(xhttp); }
        };
      });

    };
    
  </script>

  <script>
    let base_url = 'https://cwu3ebqzeb.execute-api.us-east-1.amazonaws.com/prod/';

    let post_by_presigned_url = function() {
      
      let file = document.getElementById("input-file");
      let s3_key = null;

      if (!file.value) {
        alert('No file selected');
        return;
      }

      // Start to make chains of AJAX calls
      AJAX( { url: base_url + 'post_presigned_python' }).then(function(v) {

        let s3 = JSON.parse(v.response).presigned_url;

        let data = new FormData();
        let fields = s3.fields;
        for ( let key in fields ) {
          data.append(key, fields[key]);
        }
        data.append("file", file.files[0]);
        
        s3_key = fields.key;
        return AJAX({ url: s3.url, method: 'POST', data: data, scode: [204] });

      }).then(function(v) {
        return AJAX ({ url: base_url + 'get_presigned_python/' + s3_key });

      }).then(function(v) {
        
        let presigned_url = JSON.parse(v.response).presigned_url;

        document.getElementById('span-get-file').innerHTML = '<a target="_blank" href="'
          + presigned_url + '">Download file from S3</a>';

      }).catch(function(v) {
        document.getElementById('span-error').innerHTML = 'Error: please check the log';
      });
    };

    let clear_status = function() {
      document.getElementById("input-file").value = null;
      document.getElementById('span-get-file').innerHTML = null;
      document.getElementById('span-error').innerHTML = null;
    };

  </script>

<body>

  <button onclick="clear_status()">Clear</button>
  <button onclick="post_by_presigned_url()">Submit</button>
  <input autocomplete="off" id="input-file" type="file">
  <br><br>

  <span id="span-get-file"></span>
  <span id="span-error"></span>

</body>
</html>